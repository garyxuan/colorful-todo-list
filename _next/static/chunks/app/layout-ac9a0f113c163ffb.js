(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[185],{2159:function(e,t,r){Promise.resolve().then(r.bind(r,1088)),Promise.resolve().then(r.t.bind(r,8313,23)),Promise.resolve().then(r.t.bind(r,7960,23))},1088:function(e,t,r){"use strict";r.d(t,{C:function(){return c},SyncProvider:function(){return s}});var a=r(7437),o=r(2265);let n={startColor:"#F0E6FA",endColor:"#E0F2FE"},l=(0,o.createContext)({isLoggedIn:!1,userEmail:null,lastSync:null,isLoading:!1,preferences:n,login:async()=>{},logout:()=>{},syncTodos:async()=>{},updatePreferences:async()=>{},autoSync:!0,setAutoSync:()=>{}});function s(e){let{children:t}=e,[r,s]=(0,o.useState)(!1),[c,i]=(0,o.useState)(null),[u,S]=(0,o.useState)(null),[f,y]=(0,o.useState)(!1),[g,m]=(0,o.useState)(null),[d,p]=(0,o.useState)(!0),[h,I]=(0,o.useState)(n);(0,o.useEffect)(()=>{let e=localStorage.getItem("token"),t=localStorage.getItem("userEmail"),r=localStorage.getItem("lastSync"),a=localStorage.getItem("autoSync"),o=localStorage.getItem("preferences");e&&t&&(m(e),i(t),s(!0),r&&S(new Date(r)),o&&I(JSON.parse(o))),null!==a&&p("true"===a)},[]);let _=(0,o.useCallback)(async e=>{y(!0);try{let t=await fetch("/api/auth",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,preferences:h})});if(!t.ok)throw Error("登录失败");let r=await t.json();m(r.token),i(r.user.email),S(new Date(r.user.lastSync));let a=r.user.preferences||h;I(a),s(!0),localStorage.setItem("token",r.token),localStorage.setItem("userEmail",r.user.email),localStorage.setItem("lastSync",r.user.lastSync),localStorage.setItem("preferences",JSON.stringify(a))}catch(e){throw console.error("Login error:",e),e}finally{y(!1)}},[h]),k=(0,o.useCallback)(()=>{m(null),i(null),S(null),s(!1),I(n),localStorage.removeItem("token"),localStorage.removeItem("userEmail"),localStorage.removeItem("lastSync"),localStorage.removeItem("preferences")},[]),w=(0,o.useCallback)(async e=>{if(g&&r){y(!0);try{let t=await fetch("/api/preferences",{method:"PUT",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(g)},body:JSON.stringify({preferences:e})});if(!t.ok)throw Error("更新偏好设置失败");let r=(await t.json()).preferences||e;I(r),localStorage.setItem("preferences",JSON.stringify(r))}catch(t){throw console.error("Update preferences error:",t),I(e),localStorage.setItem("preferences",JSON.stringify(e)),t}finally{y(!1)}}},[g,r]),b=(0,o.useCallback)(async e=>{if(g&&r){y(!0);try{if(!(await fetch("/api/todos",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(g)},body:JSON.stringify({todos:e})})).ok)throw Error("同步失败");S(new Date),localStorage.setItem("lastSync",new Date().toISOString())}catch(e){throw console.error("Sync error:",e),e}finally{y(!1)}}},[g,r]);return(0,a.jsx)(l.Provider,{value:{isLoggedIn:r,userEmail:c,lastSync:u,isLoading:f,preferences:h,login:_,logout:k,syncTodos:b,updatePreferences:w,autoSync:d,setAutoSync:e=>{p(e),localStorage.setItem("autoSync",String(e))}},children:t})}let c=()=>(0,o.useContext)(l)},7960:function(){},8313:function(e){e.exports={style:{fontFamily:"'__GeistSans_ded60d', '__GeistSans_Fallback_ded60d'"},className:"__className_ded60d",variable:"__variable_ded60d"}}},function(e){e.O(0,[630,971,117,744],function(){return e(e.s=2159)}),_N_E=e.O()}]);